<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Exitoso</title>
    <link rel="icon" href="../../imgs/favicon.svg?v=1" type="image/svg+xml" sizes="any">
    <link rel="stylesheet" href="../../css/mp-result.css">
</head>
<body>
    <main class="mp-shell">
      <section class="mp-card is-success">
        <header class="mp-head">
          <div class="mp-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="11" fill="rgba(255,255,255,.15)"/>
              <path d="M6.5 12.5l3.2 3.2 7.8-7.8" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h1 class="mp-title">Tu pago fue aprobado</h1>
        </header>
        <p class="mp-sub">Gracias por tu compra. En breve recibirás un correo con los detalles de tu pedido.</p>
        <div class="mp-divider"></div>
        <div class="mp-actions">
          <a class="btn" href="#" data-action="download-receipt">Ver resumen</a>
          <a class="btn btn--primary" href="../index.html">Ir al inicio</a>
        </div>
      </section>
    </main>
        <script type="module">
      import { BASE_URL } from '../../scriptsFolder/api/apiClient.js';

      // Limpiar el carrito de compras al llegar a la página de éxito.
      // Esto es crucial para que el usuario no vea los productos que acaba de comprar.
      try {
        localStorage.removeItem('carrito');
        console.log('Carrito de compras limpiado tras pago exitoso.');
      } catch (e) { console.error('No se pudo limpiar el carrito:', e); }

      const btn = document.querySelector('[data-action="download-receipt"]');
      btn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const params = new URLSearchParams(location.search);
        const ventaId = params.get('external_reference') || params.get('merchant_order_id');
        if (!ventaId) {
          alert('No se encontro el identificador de la venta.');
          return;
        }
        try {
          const token = localStorage.getItem('jwt_token');
          const url = `${BASE_URL}/ventas/${ventaId}/comprobante.pdf`;
          const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
          const resp = await fetch(url, { headers });
          if (!resp.ok) {
            const text = await resp.text();
            throw new Error(text || `Error ${resp.status}`);
          }
          const blob = await resp.blob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `comprobante-venta-${ventaId}.pdf`;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 2000);
        } catch (err) {
          console.error('Error descargando comprobante:', err);
          alert('No se pudo descargar el comprobante.');
        }
      });

    </script>
  </body>
</html>
