<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restablecer contraseña</title>
  <link rel="icon" href="../imgs/favicon.svg?v=1" type="image/svg+xml" sizes="any">
  <link rel="stylesheet" href="../css/mp-result.css">
  <style>
    .mp-form{display:grid;gap:10px;margin:10px 0 4px}
    .mp-field{display:grid;gap:6px}
    .mp-field label{font-size:14px;color:var(--muted)}
    .mp-input{height:46px;border:1px solid var(--line);border-radius:12px;padding:0 12px;font-size:15px;outline:none;background:#fff}
    .mp-input:focus{box-shadow:0 0 0 3px rgba(115,102,255,.12);border-color:#cfd8ff}
    .mp-error{color:var(--error);font-size:14px;margin-top:4px;display:none}
  </style>
  <script type="module">
    import { resetearPassword } from '../scriptsFolder/api/api_auth.js';

    const qs = (sel, ctx=document) => ctx.querySelector(sel);
    const setVariant = (variant) => {
      const card = qs('.mp-card');
      card.classList.remove('is-success','is-failure','is-pending');
      if (variant) card.classList.add(variant);
    };

    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(location.search);
      const token = params.get('token');
      const title = qs('.mp-title');
      const sub = qs('.mp-sub');
      const form = qs('#resetForm');
      const errorBox = qs('#formError');
      const actions = qs('.mp-actions');

      if (!token) {
        setVariant('is-failure');
        title.textContent = 'Enlace inválido o expirado';
        sub.textContent = 'El enlace para restablecer tu contraseña no es válido o ha expirado.';
        form.style.display = 'none';
        actions.innerHTML = `<a class="btn btn--primary" href="index.html">Ir al inicio</a>`;
        return;
      }

      setVariant('is-pending');
      title.textContent = 'Restablecer contraseña';
      sub.textContent = 'Ingresa tu nueva contraseña y confírmala para continuar.';

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorBox.style.display = 'none';
        errorBox.textContent = '';
        const pass = qs('#newPassword').value.trim();
        const confirm = qs('#confirmPassword').value.trim();

        if (pass.length < 6) {
          errorBox.textContent = 'La contraseña debe tener al menos 6 caracteres.';
          errorBox.style.display = 'block';
          return;
        }
        if (pass !== confirm) {
          errorBox.textContent = 'Las contraseñas no coinciden.';
          errorBox.style.display = 'block';
          return;
        }

        try {
          await resetearPassword(token, pass);
          setVariant('is-success');
          title.textContent = 'Contraseña actualizada';
          sub.textContent = 'Tu contraseña fue restablecida correctamente. Ahora puedes iniciar sesión con la nueva contraseña.';
          form.style.display = 'none';
          actions.innerHTML = `
            <a class="btn" href="index.html">Volver al inicio</a>
            <a class="btn btn--primary" href="index.html">Ir a iniciar sesión</a>
          `;
        } catch (err) {
          setVariant('is-failure');
          errorBox.textContent = (err && err.message) ? err.message : 'No se pudo actualizar la contraseña. Intenta nuevamente.';
          errorBox.style.display = 'block';
        }
      });
    });
  </script>
</head>
<body>
  <main class="mp-shell">
    <section class="mp-card is-pending">
      <header class="mp-head">
        <div class="mp-icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="11" fill="rgba(255,255,255,.15)"/>
            <path d="M17 10V8a5 5 0 0 0-10 0v2" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
            <rect x="5" y="10" width="14" height="10" rx="2" stroke="#fff" stroke-width="2"/>
          </svg>
        </div>
        <h1 class="mp-title">Restablecer contraseña</h1>
      </header>
      <p class="mp-sub">Ingresa tu nueva contraseña y confírmala para continuar.</p>

      <form id="resetForm" class="mp-form" novalidate>
        <div class="mp-field">
          <label for="newPassword">Nueva contraseña</label>
          <input id="newPassword" name="newPassword" type="password" class="mp-input" placeholder="••••••••" required>
        </div>
        <div class="mp-field">
          <label for="confirmPassword">Confirmar contraseña</label>
          <input id="confirmPassword" name="confirmPassword" type="password" class="mp-input" placeholder="••••••••" required>
        </div>
        <div id="formError" class="mp-error"></div>
      </form>

      <div class="mp-divider"></div>
      <div class="mp-actions">
        <a class="btn" href="index.html">Cancelar</a>
        <button class="btn btn--primary" type="submit" form="resetForm">Restablecer contraseña</button>
      </div>
    </section>
  </main>
</body>
</html>
